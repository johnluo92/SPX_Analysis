<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Distribution</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemBox, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            color: #e0e0e0;
        }
        
        .chart-container {
            padding: 24px;
        }
        
        .chart-body {
            min-height: 500px;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <div id="distributionChart" class="chart-body"></div>
    </div>

    <script>
        async function loadData() {
            try {
                const timestamp = Date.now();
                const [anomaly, historical] = await Promise.all([
                    fetch(`../../json_data/anomaly_report.json?t=${timestamp}`).then(r => r.json()),
                    fetch(`../../json_data/historical_anomaly_scores.json?t=${timestamp}`).then(r => r.json())
                ]);
                
                renderDistribution(anomaly, historical);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function renderDistribution(anomaly, historical) {
            const scores = historical.ensemble_scores;
            const currentScore = anomaly.ensemble.score;
            
            const histTrace = {
                x: scores,
                type: 'histogram',
                name: 'Score Distribution',
                nbinsx: 40,
                marker: {
                    color: '#3b82f6',
                    line: { color: '#1e40af', width: 1 }
                },
                opacity: 0.7
            };
            
            const kde = calculateKDE(scores, 100);
            const kdeTrace = {
                x: kde.x,
                y: kde.y,
                type: 'scatter',
                mode: 'lines',
                name: 'Density',
                line: { color: '#8b5cf6', width: 3 },
                yaxis: 'y2',
                fill: 'tozeroy',
                fillcolor: 'rgba(139, 92, 246, 0.2)'
            };
            
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0', family: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif' },
                margin: { l: 60, r: 60, t: 60, b: 60 },
                xaxis: {
                    title: 'Anomaly Score',
                    gridcolor: '#2a2a2a',
                    range: [0, 1]
                },
                yaxis: {
                    title: 'Frequency',
                    gridcolor: '#2a2a2a'
                },
                yaxis2: {
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false,
                    title: 'Density'
                },
                shapes: [
                    {
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: 0,
                        x1: 0.50,
                        y0: 0,
                        y1: 1,
                        fillcolor: '#10b981',
                        opacity: 0.1,
                        line: { width: 0 }
                    },
                    {
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: 0.50,
                        x1: 0.70,
                        y0: 0,
                        y1: 1,
                        fillcolor: '#f59e0b',
                        opacity: 0.1,
                        line: { width: 0 }
                    },
                    {
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: 0.70,
                        x1: 1,
                        y0: 0,
                        y1: 1,
                        fillcolor: '#ef4444',
                        opacity: 0.1,
                        line: { width: 0 }
                    },
                    {
                        type: 'line',
                        x0: 0.50,
                        x1: 0.50,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: { color: '#f59e0b', width: 2, dash: 'dot' }
                    },
                    {
                        type: 'line',
                        x0: 0.70,
                        x1: 0.70,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: { color: '#ef4444', width: 2, dash: 'dot' }
                    },
                    {
                        type: 'line',
                        x0: currentScore,
                        x1: currentScore,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: { color: '#ffffff', width: 4 }
                    }
                ],
                annotations: [
                    {
                        x: 0.25,
                        y: 1.08,
                        yref: 'paper',
                        text: 'NORMAL',
                        showarrow: false,
                        font: { color: '#10b981', size: 11, weight: 700 }
                    },
                    {
                        x: 0.60,
                        y: 1.08,
                        yref: 'paper',
                        text: 'MODERATE',
                        showarrow: false,
                        font: { color: '#f59e0b', size: 11, weight: 700 }
                    },
                    {
                        x: 0.85,
                        y: 1.08,
                        yref: 'paper',
                        text: 'HIGH',
                        showarrow: false,
                        font: { color: '#ef4444', size: 11, weight: 700 }
                    },
                    {
                        x: currentScore,
                        y: 1.15,
                        yref: 'paper',
                        text: `CURRENT: ${currentScore.toFixed(3)}`,
                        showarrow: true,
                        arrowhead: 2,
                        arrowsize: 1,
                        arrowwidth: 2,
                        arrowcolor: '#ffffff',
                        ax: 0,
                        ay: -30,
                        font: { color: '#ffffff', size: 12, weight: 700 },
                        bgcolor: 'rgba(0, 0, 0, 0.8)',
                        bordercolor: '#ffffff',
                        borderwidth: 2,
                        borderpad: 4
                    }
                ],
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(20, 20, 30, 0.8)',
                    bordercolor: '#333',
                    borderwidth: 1
                }
            };
            
            Plotly.newPlot('distributionChart', [histTrace, kdeTrace], layout, { 
                responsive: true, 
                displayModeBar: false 
            });
        }
        
        function calculateKDE(data, points) {
            const min = Math.min(...data);
            const max = Math.max(...data);
            const bandwidth = 0.05;
            
            const x = [];
            const y = [];
            
            for (let i = 0; i <= points; i++) {
                const xi = min + (max - min) * i / points;
                x.push(xi);
                
                let density = 0;
                for (const point of data) {
                    const u = (xi - point) / bandwidth;
                    density += Math.exp(-0.5 * u * u) / Math.sqrt(2 * Math.PI);
                }
                y.push(density / (data.length * bandwidth));
            }
            
            const maxY = Math.max(...y);
            const normalized = y.map(val => (val / maxY) * data.length * 0.3);
            
            return { x, y: normalized };
        }
        
        loadData();
        setInterval(loadData, 15 * 60 * 1000);
    </script>
</body>
</html>