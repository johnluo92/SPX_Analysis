CONTEXT

I have a VIX forecasting system that has accumulated too much complexity. It currently trains 28 models with quantile regression, confidence scores, and heavy calibration logic. Performance is mediocre and the system is difficult to iterate on.

Current problems:
- Quantile calibration is broken (q10 capturing 22.5% instead of 10%)
- Confidence score is useless (-0.042 correlation with error)
- Training 28 models when I only need 2
- Direction accuracy ~58%, MAE ~13%
- System is too complex to debug or improve

What I actually need:
- Direction probability (will VIX go up or down?)
- Magnitude estimate (by how much in %)
- For 5-day horizon only (start simple)
- Accuracy target: 65-70% direction, MAE < 10%

YOUR TASK

Refactor my training system to be dead simple. You have full permission to overwrite any file. No backward compatibility concerns. Use existing class names and imports where possible to avoid breaking references across files.

Step 1: Simplify Config

File: config.py

Remove all quantile objectives
Remove confidence model objective
Add only two objectives: direction_5d and magnitude_5d
Target variable remains log-transformed VIX change
Keep temporal validation settings
Keep cohort definitions but we'll use them as features not separate models

Critical: Make sure variable names in config match exactly what other files expect. If xgboost_trainer_v3.py looks for MODEL_OBJECTIVES, keep that exact name.

Step 2: Simplify Trainer

File: xgboost_trainer_v3.py (overwrite existing, keep same filename)

Rewrite this completely but keep the class name and main function signatures so imports don't break.

What it should do:
1. Take full feature dataframe as input
2. Create cohort binary features: is_fomc_period, is_opex_week, is_earnings_heavy (mid_cycle is baseline where all flags are 0)
3. Create 5-day forward target (log-space VIX change)
4. Split train/test by date (train up to 2022-12-31)
5. Train TWO models only:
   - Direction classifier: Binary (up/down based on log-space target > 0)
   - Magnitude regressor: Continuous (log-space VIX change, converted to % for output)
6. Save both models with clear naming
7. Report metrics:
   - Direction: accuracy, precision, recall, and probability calibration
   - Magnitude: MAE, RMSE, bias overall and by cohort
8. No calibration logic initially - just train and evaluate cleanly

Critical requirements:
- Single model per objective (no per-cohort models)
- Cohorts are input features, not model splits
- Proper temporal hygiene (no future data leakage)
- Models saved with consistent naming that production script can find

Step 3: Feature Selection

File: xgboost_feature_selector_v2.py (modify existing or rewrite)

What it should do:
1. Train the magnitude regressor on all 168 features
2. Run SHAP to get feature importance
3. Select top 40 features based on SHAP values
4. Always include cohort flags (is_fomc_period, is_opex_week, is_earnings_heavy) in final feature set even if SHAP ranks them low
5. Save selected feature list to a file that other scripts can load
6. Generate diagnostic plots showing top features and their importance
7. Return the list of selected features

Make sure the output format matches what the training script expects when it loads selected features.

Step 4: Update Training Script

File: train_probabilistic_models.py

Simplify the main orchestration:

1. Load data using existing data_fetcher and feature_engineer (keep as-is)
2. Run feature selection to get top 40 features plus cohort flags
3. Train direction and magnitude models using simplified trainer
4. Save models with clear names
5. Report summary metrics to console
6. Save training report JSON

Remove all calibration steps, quantile training, confidence model training. Focus on clean execution of the 2-model training.

Critical: Make sure the script uses the exact same config variable names and paths that other scripts expect.

Step 5: Update Walk-Forward Validation

File: walk_forward_validation.py

Simplify to match new system.

What to validate:
- Direction calibration: when model says 70% up, is it right 70% of the time? Create calibration plot.
- Direction accuracy overall and by cohort: is FOMC really different from OpEx?
- Magnitude MAE overall and by cohort: which regimes are harder to predict?
- Magnitude bias: are we systematically over/under predicting?

Remove:
- All quantile coverage metrics
- Confidence score analysis
- Interval coverage metrics

Generate clean plots and a summary report. The validation should give clear signal on whether the models are working.

Step 6: Update Production Script

File: integrated_system_production.py

Simplify output format to show only what matters.

Forecast output should show:

5-Day VIX Forecast (date)
Current VIX: X.XX

Direction:
  Probability UP:   XX.X%
  Probability DOWN: XX.X%
  
Magnitude:
  Expected change: +/-X.X%
  Expected VIX: XX.X
  
Context:
  Current cohort: cohort_name
  Feature date: date

Remove:
- All quantile outputs (q10, q25, q75, q90)
- Confidence score
- Uncertainty spreads
- Any calibrator references

The script should load the 2 models, generate features for today, apply cohort flags, make predictions, and output clean results.

Critical: Make sure model loading uses the same filenames that the training script saves.

Files to Keep As-Is

These work fine, don't touch them unless you find a bug:
- data_fetcher.py
- feature_engineer.py
- temporal_validator.py
- prediction_database.py

File to Delete or Ignore

- forecast_calibrator.py (not needed for this simplified version)

FUTURE ADDITIONS - DO NOT IMPLEMENT YET

Later we will add:
1. OHLC-based features for intraday volatility
2. Additional horizons (1d, 8d, 13d, 21d)
3. Recalibration logic if direction probabilities are miscalibrated
4. More sophisticated feature engineering

For now: just get 5-day direction plus magnitude working well.

SUCCESS CRITERIA

When you are done, I should be able to:
1. Run python train_probabilistic_models.py - trains 2 models cleanly
2. Run python integrated_system_production.py --mode complete - validates and forecasts
3. See clean output showing direction probability plus magnitude estimate
4. Achieve 60%+ direction accuracy and under 12% MAE on walk-forward validation

The system should be simple enough that I can understand every piece and iterate quickly on feature engineering. Code should compile and run without errors. Variable names should be consistent across all files.

MY CURRENT CODE

All 12 files from the GitHub repo are attached. Read through each one carefully to understand the existing structure before making changes.

INSTRUCTIONS

Use extended thinking to plan the refactoring carefully. Make sure variable names, file paths, and function signatures are consistent across all modified files. When you change something in one file, check if other files reference it and update those too.

Work through Steps 1-6 systematically. After modifying each file, verify it will work with the other files in the system.

Ask clarifying questions if you encounter ambiguity, but bias toward making decisions that simplify the system. When in doubt, remove complexity rather than preserve it.

The goal is a working system that trains 2 models for 5-day VIX forecasting with direction probability and magnitude estimate. Everything should compile, run, and produce useful output.

Focus on making this work correctly first. Optimization and additional features come later.