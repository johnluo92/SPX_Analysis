<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Test - All Fixed Charts</title>
    <script src="data_service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .status {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #10b981;
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            min-height: 400px;
        }
        
        .chart-card iframe {
            width: 100%;
            height: 400px;
            border: none;
            display: block;
        }
        
        .chart-card.large {
            grid-column: 1 / -1;
        }
        
        .chart-card.large iframe {
            height: 500px;
        }
        
        .info-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-panel h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #3b82f6;
        }
        
        .info-panel ul {
            list-style: none;
            font-size: 13px;
            line-height: 1.8;
        }
        
        .info-panel li:before {
            content: "âœ“ ";
            color: #10b981;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .debug-panel {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .debug-panel h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #f59e0b;
        }
        
        .debug-panel pre {
            background: #000;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            line-height: 1.6;
            color: #10b981;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¯ Dashboard Test Suite</h1>
        <p>All charts fixed and working with mock data</p>
    </div>
    
    <div class="status" id="statusBadges">
        <div class="status-badge">Loading...</div>
    </div>
    
    <div class="info-panel">
        <h2>âœ… Fixes Applied</h2>
        <ul>
            <li>Fixed syntax error in forward_returns.html (removed duplicate brace)</li>
            <li>Added null-safe data access across all charts</li>
            <li>Created mock data_service.js for testing</li>
            <li>Implemented graceful error handling</li>
            <li>Fixed threshold access patterns</li>
            <li>Added defensive programming throughout</li>
        </ul>
    </div>
    
    <div class="grid">
        <div class="chart-card large">
            <iframe src="detector_grid_hero.html" title="Detector Grid"></iframe>
        </div>
        
        <div class="chart-card">
            <iframe src="detector_ranking.html" title="Detector Ranking"></iframe>
        </div>
        
        <div class="chart-card">
            <iframe src="persistence_tracker.html" title="Persistence Tracker"></iframe>
        </div>
        
        <div class="chart-card large">
            <iframe src="historical_analysis.html" title="Historical Analysis"></iframe>
        </div>
        
        <div class="chart-card">
            <iframe src="score_distribution.html" title="Score Distribution"></iframe>
        </div>
        
        <div class="chart-card">
            <iframe src="forward_returns.html" title="Forward Returns"></iframe>
        </div>
    </div>
    
    <div class="debug-panel">
        <h2>ðŸ”§ Debug Information</h2>
        <button onclick="runDebug()">Run Debug Check</button>
        <pre id="debugOutput">Click "Run Debug Check" to see data service status...</pre>
    </div>
    
    <script>
        async function initStatus() {
            const statusDiv = document.getElementById('statusBadges');
            
            try {
                await window.dataService.init();
                
                const checks = [
                    { name: 'Data Service', test: () => window.dataService.initialized },
                    { name: 'Anomaly Data', test: () => window.dataService.getAnomalyState().ensemble_score > 0 },
                    { name: 'Historical Data', test: () => window.dataService.getHistoricalData().dates.length > 0 },
                    { name: 'Thresholds', test: () => window.dataService.getThresholds().moderate > 0 }
                ];
                
                let badges = '';
                checks.forEach(check => {
                    try {
                        const passed = check.test();
                        badges += `<div class="status-badge ${passed ? '' : 'error'}">${check.name}: ${passed ? 'âœ“' : 'âœ—'}</div>`;
                    } catch (e) {
                        badges += `<div class="status-badge error">${check.name}: ERROR</div>`;
                    }
                });
                
                statusDiv.innerHTML = badges;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-badge error">Initialization Failed: ${error.message}</div>`;
            }
        }
        
        function runDebug() {
            const output = document.getElementById('debugOutput');
            try {
                const info = {
                    initialized: window.dataService.initialized,
                    anomalyScore: window.dataService.getAnomalyState().ensemble_score,
                    marketPrice: window.dataService.getMarketState().spx_price,
                    vix: window.dataService.getMarketState().vix,
                    historicalPoints: window.dataService.getHistoricalData().dates.length,
                    thresholds: window.dataService.getThresholds(),
                    detectorCount: Object.keys(window.dataService.getAnomalyState().detector_scores).length,
                    persistenceStreak: window.dataService.getPersistenceState().historical_stats.current_streak
                };
                
                output.textContent = JSON.stringify(info, null, 2);
            } catch (error) {
                output.textContent = `Error: ${error.message}\n${error.stack}`;
            }
        }
        
        // Initialize on load
        initStatus();
        
        // Log any iframe errors
        window.addEventListener('message', (event) => {
            if (event.data.type === 'error') {
                console.error('Chart Error:', event.data);
            }
        });
    </script>
</body>
</html>
